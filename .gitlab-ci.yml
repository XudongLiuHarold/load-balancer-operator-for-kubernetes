image: "kscom-docker-local.artifactory.eng.vmware.com/tkg-extensions-ci/golang-docker-cli:1.13.9"

stages:
- lint
- test
- build
# - e2etest

variables:
  DOCKER_HOST: tcp://localhost:2375/
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

lint:
  stage: lint
  services:
  - docker:19.03.8-dind
  before_script:
  - docker info
  script: make lint
  only:
    changes:
    - .gitlab-ci.yml
    - Makefile
    - "**/*.go"
    - "hack/*.sh"

unit-test:
  stage: test
  script: make test
  only:
    changes:
    - .gitlab-ci.yml
    - Makefile
    - "**/*.go"
    - "config/**/*"
    - "go.{mod,sum}"

integration-test:
  stage: test
  script: make integration-test
  only:
    changes:
    - .gitlab-ci.yml
    - Makefile
    - "**/*.go"
    - "config/**/*"
    - "go.{mod,sum}"

build-images:
  stage: build
  services:
  - docker:19.03.8-dind
  before_script:
  - docker info
  script: make docker-build

# e2e-test:
#   stage: e2etest
#   services:
#     - docker:19.03.8-dind
#   script: make e2e-test
#   timeout: 30m
